@using DungeonSlayers.Extensions
@using DungeonSlayers.Models
@using DungeonSlayers.Repositories
@using Newtonsoft.Json
@model DungeonSlayers.Models.Character

@{
    ViewBag.Title = "Edit - Character";
    Layout = "~/Views/Shared/_Layout.cshtml";
}


<form data-bind="submit: save">
    @*@using (Html.BeginForm())*@
    @*{*@
    @Html.AntiForgeryToken()


    <div class="form-vertical">
        <div class="row">
            <div class="col-md-6"><h2>Edit - Character</h2></div>
            <div class="col-sm-6 pull-down">
                <div class="btn-toolbar pull-right">
                    <button type="submit" value="Create" class="btn btn-primary">Save</button>
                    @Html.ActionLink("Back", "Index", null, new { @class = "btn btn-danger" })
                </div>
            </div>
        </div>
        </div>
        <div class="row" ><hr /></div>
        <div id="feedback" class="row">
            <div id="success" style="color:green">
            </div>
            <div id="error" style="color:red">
                @Html.ValidationSummary()
            </div>
        </div>
        @*<div class="btn-group btn-lg">*@
        @*</div>*@
        @Html.ValidationSummary(true, "", new { @class = "text-danger" })

        @Html.Partial("~/Views/Shared/_CharacterHeaderPartial.cshtml", Model)

        @Html.Partial("~/Views/Shared/_AttributesTraitsPartial.cshtml", Model)

        @Html.Partial("~/Views/Shared/_CombatValuesPartial.cshtml", Model)

        <div class="row">
            <div class="col-sm-12 col-md-7">
                @Html.Partial("~/Views/Shared/_WeaponsPartial.cshtml", Model)
            </div>
            <div class="col-sm-12 col-md-5">
                @Html.Partial("~/Views/Shared/_ArmorPartial.cshtml", Model)
            </div>
            <div class="col-sm-12">
                @Html.Partial("~/Views/Shared/_SpellPartial.cshtml", Model)
            </div>
        </div>
        <div class="row" style="font-size:smaller;">
            <div class="col-sm-12 col-md-6">
                @Html.Partial("~/Views/Shared/_PPRecordPartial.cshtml", Model)
            </div>

            <div class="col-sm-12 col-md-6">
                @Html.Partial("~/Views/Shared/_GoldPartial.cshtml",Model)
            </div>
        </div>
        <div class="row">
            <div class="col-sm-12 col-md-6">
                @Html.Partial("~/Views/Shared/_EquipmentPartial.cshtml",Model)
            </div>
            <div class="col-sm-12 col-md-6">
                @Html.Partial("~/Views/Shared/_MagicEquipmentPartial.cshtml", Model)
            </div>
            <div class="col-sm-12 col-md-6">
                @Html.Partial("~/Views/Shared/_TalentPartial.cshtml", Model)
            </div>
            <div class="col-sm-12 col-md-6">
                @Html.Partial("~/Views/Shared/_CharacteristicsPartial.cshtml", Model)
            </div>
        </div>
    </div>
    @*}*@
</form>

@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")
    <script type="text/javascript">

        $(function () {

            var jsonModel = '@Html.Raw(JsonConvert.SerializeObject(this.Model, Formatting.None, new JsonSerializerSettings
            {
                ReferenceLoopHandling = ReferenceLoopHandling.Ignore
            }))';
            var Model = ko.mapping.fromJSON(jsonModel);

            var antiForgeryToken = $('input[name="__RequestVerificationToken"]').val();
            if (antiForgeryToken) {
                Model.__RequestVerificationToken = antiForgeryToken;
            }

            Model.AV = ko.computed(function () {
                var av = 0;
                for (var i in Model.Armors()) {
                    var armor = Model.Armors()[i];
                    if (armor.Equipped()) {
                        av += armor.Armor.AV();
                    }
                }
                return av;
            }, this);

            Model.SM = ko.computed(function () {
                return 0;
            }, this);

            Model.WB = ko.computed(function () {
                return 0;
            }, this);

            var jsonCombatProperties = '@Html.Raw(JsonConvert.SerializeObject(((IEnumerable<PropertyDef>)this.ViewBag.PropertyDefs).CombatValues()))';

            @foreach(var def in ((IEnumerable<PropertyDef>)this.ViewBag.PropertyDefs).CombatValues())
            {
                @Html.Raw("Model." + def.Acronym+ " = ko.pureComputed(function() {\n" +
                    "    return "+def.DataBinding+";\n"+
               "}, this);\n")
            }

            var weapons = JSON.parse('@Html.Raw(JsonConvert.SerializeObject((IEnumerable<Weapon>)this.ViewBag.Weapons))');
            var armors = JSON.parse('@Html.Raw(JsonConvert.SerializeObject((IEnumerable<Armor>)this.ViewBag.Armors))');


            @foreach (string Self in (IEnumerable<string>)this.ViewBag.SelfTypes)
            {
                var self = Self.ToLower();
                //
                @Html.Raw($@"Model.update{Self} = function(id) {{
                    {self} = $.grep({self}s, function(e) {{ return e.Id == id; }});
                    if ({self})
                    {{
                        ko.mapping.fromJS({self}[0], {{ }}, this.{Self});
                    }}
                }}
                Model.add{Self} = function() {{
                    {self} = {self}s[0];
                    {self}Id = ko.observable({self}.Id);
                    wc = {{ CharacterId: Model.Id, {Self}Id: {self}Id, {Self}: ko.mapping.fromJS({self}), Equipped: ko.observable(false) }}
                    {self}Id.subscribe(Model.update{Self}, wc);
                    Model.{Self}s.push(wc);
                    $('#{self}Table select').selectpicker('refresh');
                }}
                Model.remove{Self} = function({self}) {{
                    Model.{Self}s.remove({self});
                }}
                Model.switchTo{Self} = function({self}) {{
                    for (var i in Model.{Self}s()) {{
                        Model.{Self}s()[i].Equipped(false);
                    }}
                    {self}.Equipped(true);
                }}
                for (i in Model.{Self}s()) {{
                    wc = Model.{Self}s()[i];
                    wc.{Self}Id.subscribe(Model.update{Self}, wc);
                }}");
                //
            }
            //

            //Model.updateWeapon = function (id) {
            //    weapon = $.grep(weapons, function (e) { return e.Id == id; });
            //    if (weapon) {
            //        ko.mapping.fromJS(weapon[0], {}, this.Weapon);
            //    }
            //}
            //Model.addWeapon = function () {
            //    weapon = weapons[0];
            //    weaponId = ko.observable(weapon.Id);
            //    wc = { CharacterId: Model.Id, WeaponId: weaponId, Weapon: ko.mapping.fromJS(weapon) }
            //    weaponId.subscribe(Model.updateWeapon, wc);
            //    Model.Weapons.push(wc);
            //    $('#weaponTable select').selectpicker('refresh');
            //}
            //Model.removeWeapon = function (weapon) {
            //    Model.Weapons.remove(weapon);
            //}
            //for (i in Model.Weapons()) {
            //    wc = Model.Weapons()[i];
            //    wc.WeaponId.subscribe(Model.updateWeapon, wc);
            //}
            Model.save = function () {
                //ko.utils.postJson(location.href, { character: ko.toJSON(Model) });
                $.ajax({
                    url: '/Characters/Edit',
                    type: 'POST',
                    data: ko.toJSON(Model),
                    contentType: 'application/json; charset=utf-8',
                    success: function (data) {
                        $("#success").text("Character Save Successful").fadeIn(0).delay(3000).fadeOut(1000);
                    },
                    error: function (xhr, ajaxOptions, thrownError) {
                        $('#error').text("Character Save Fails (" + xhr.status + ") - " + xhr.responseText).fadeIn(0).delay(10000).fadeOut(1000);

                    }
                });
            }

            ko.applyBindings(Model);
        });
    </script>
}
